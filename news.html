<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News - Earn</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 
    
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script> 
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <style>
        .news-earn-card { background:white; border-radius:15px; margin-bottom:20px; box-shadow:0 4px 12px rgba(0,0,0,0.05); overflow:hidden; }
        .news-image { width:100%; height:140px; object-fit:cover; }
        .news-content { padding:15px; }
        .news-title { font-size:18px; font-weight:bold; margin-bottom:8px; }
        .news-description { font-size:14px; color:#555; margin-bottom:12px; }
        .task-footer { display:flex; justify-content:space-between; align-items:center; padding-top:12px; border-top:1px solid #eee; }
        .btn-earn { background:#6a5acd; color:white; padding:10px 18px; border-radius:10px; font-weight:bold; }
        .earn-info strong { color:#6a5acd; font-size:15px; }

        /* ‡¶™‡¶™‡¶Ü‡¶™ */
        .popup-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; display:none; justify-content:center; align-items:center; }
        .popup { background:white; padding:30px; border-radius:20px; text-align:center; max-width:90%; border:5px solid #27ae60; }
        .popup i { font-size:60px; color:#27ae60; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="title" style="margin-bottom:20px;">News & Earn</h2>
        <div id="news-task-list"></div>
    </div>

    <div id="task-modal" style="position:fixed; top:0; left:0; right:0; bottom:0; background:white; z-index:2000; display:none; padding:10px;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px;">
            <button onclick="closeTask()" style="background:none; border:none; font-size:24px; color:#6a5acd;">Close</button>
            <h4 id="timer-display" style="margin:0; color:#6a5acd;">Time: 00:00</h4>
            <button id="complete-btn" disabled style="background:#27ae60; color:white; padding:8px 15px; border-radius:8px;">Complete</button>
        </div>
        <iframe id="news-iframe" style="width:100%; height:calc(100% - 60px); border:none; margin-top:10px;" allow="fullscreen; geolocation; camera; microphone"></iframe>
    </div>

    <div class="popup-overlay" id="success-popup">
        <div class="popup">
            <i class="fas fa-check-circle"></i><br><br>
            <h3>‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®!</h3>
            <p id="earn-message">‡¶Ü‡¶™‡¶®‡¶ø ‡ßß‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶â‡¶™‡¶æ‡¶∞‡ßç‡¶ú‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®!</p>
        </div>
    </div>

    <nav class="bottom-nav">
      <button class="nav-item" onclick="goToHome()">Home</button>
      <button class="nav-item" onclick="goToSupport()">Support</button>
      <button class="nav-item active">News</button>
      <button class="nav-item"onclick="goToWithdraw()">Withdraw</button>
      <button class="nav-item"onclick="goToProfile()">Profile</button>
    </nav>

    <script>
// news.html ‡¶è‡¶∞ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü

// ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
const VIDEO_BLOCK_ID = "17904"; 
const INTERSTITIAL_BLOCK_ID = "int-17904";

const firebaseConfig = {
    apiKey: "AIzaSyBQf-ILFW6jDV-c_O2LG2elA5oAB84p2XQ",
    authDomain: "top-news-91db8.firebaseapp.com",
    databaseURL: "https://top-news-91db8-default-rtdb.firebaseio.com",
    projectId: "top-news-91db8",
    storageBucket: "top-news-91db8.firebasestorage.app",
    messagingSenderId: "348369077928",
    appId: "1:348369077928:web:7629c503c30cbf7450649d",
    measurementId: "G-7GMX8N2NSC"
};

// üî• ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã ‡¶Ø‡ßá firebase-app ‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶™‡¶∞‡¶á ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡ßü‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ‡¶π‡¶ö‡ßç‡¶õ‡ßá
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(); 

// Adsgram Init
let VideoAdController = window.Adsgram?.init({ blockId: VIDEO_BLOCK_ID });
let InterstitialAdController = window.Adsgram?.init({ blockId: INTERSTITIAL_BLOCK_ID });

// üî• ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶≤‡¶ú‡¶ø‡¶ï
let currentUser = null; 
const tg = window.Telegram.WebApp;

if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
    tg.ready();
    tg.expand();
    currentUser = tg.initDataUnsafe.user.id.toString();
} else {
    // ‡¶Ø‡¶¶‡¶ø ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú ‡¶¨‡¶æ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü‡ßá‡¶° ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞
    currentUser = localStorage.getItem('newsApp_guestId');
    if (!currentUser) {
        currentUser = "guest_" + Date.now();
        localStorage.setItem('newsApp_guestId', currentUser);
    }
}

let currentTask = null;
let timerInterval = null;
let timer = 0;

// ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® (‡¶™‡¶æ‡¶∞‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶∏‡¶π)
function goToHome() { setTimeout(() => window.location.href = 'index.html', 0); }
function goToSupport() { setTimeout(() => window.location.href = 'support.html', 0); }
function goToNews() { setTimeout(() => window.location.href = 'news.html', 0); } 
function goToWithdraw() { setTimeout(() => window.location.href = 'withdraw.html', 0); }
function goToProfile() { setTimeout(() => window.location.href = 'profile.html', 0); }

// ‡¶®‡¶ø‡¶â‡¶ú ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
function loadNewsFirestore() {
    const container = document.getElementById("news-task-list");
    container.innerHTML = '<p style="text-align:center;">‡¶®‡¶ø‡¶â‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>';

    // üî• ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: get() ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã ‡¶Ø‡¶æ‡¶§‡ßá Webview ‡¶§‡ßá ‡¶∏‡ßç‡¶•‡¶ø‡¶§‡¶ø‡¶∂‡ßÄ‡¶≤ ‡¶π‡¶Ø‡¶º
    db.collection("news").orderBy("timestamp", "desc").get()
        .then(async snap => {
            container.innerHTML = "";
            if(snap.empty) {
                container.innerHTML = '<p style="text-align:center;">‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶ø‡¶â‡¶ú ‡¶®‡ßá‡¶á‡•§</p>';
                return;
            }
            
            // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶°
            let userData = null;
            if (currentUser && !currentUser.startsWith('guest_')) {
                const userDoc = await db.collection('users').doc(currentUser).get();
                userData = userDoc.data();
            }

            snap.forEach(doc => {
                const n = doc.data();
                const readKey = `read_${currentUser}_${doc.id}`; 
                
                const alreadyRead = localStorage.getItem(readKey) || (userData && userData.readNews?.[doc.id]);
                const isDailyLimitReached = userData?.adsWatchedToday >= 10;
                
                let buttonText = "Earn Now";
                let onClickFn = `openNewsTask('${doc.id}')`; 
                let isDisabled = false;

                if (alreadyRead) {
                    buttonText = "Viewed";
                    onClickFn = `openNewsTask('${doc.id}', false)`; 
                    isDisabled = true;
                } else if (isDailyLimitReached) {
                    buttonText = "Limit Reached";
                    onClickFn = `tg.showAlert('‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∏‡ßÄ‡¶Æ‡¶æ ‡¶∂‡ßá‡¶∑ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');`;
                    isDisabled = true;
                } else {
                    buttonText = "Earn Now";
                }
                
                container.innerHTML += `
                    <div class="news-earn-card" style="${alreadyRead || isDailyLimitReached ? 'opacity: 0.6;' : ''}">
                        <img src="${n.imageUrl}" class="news-image" onerror="this.style.display='none'">
                        <div class="news-content">
                            <h3 class="news-title">${n.title}</h3>
                            <p class="news-description">${n.description}</p>
                            <div class="task-footer">
                                <button class="btn-earn" onclick="${onClickFn}" ${isDisabled ? 'disabled' : ''}> 
                                    ${buttonText}
                                </button>
                                ${!alreadyRead && !isDailyLimitReached ? `<div class="earn-info"><strong>‡ß≥${n.points}</strong> ‚Ä¢ ${Math.ceil(n.readTime/60)} min</div>` : ''}
                            </div>
                        </div>
                    </div>`;
            });
        })
        .catch(error => {
            // üî• ‡¶è‡¶∞‡¶∞ ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶ø‡¶Ç ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
            console.error("Firestore fetch error:", error);
            container.innerHTML = `<p style="text-align:center; color: #ff7675;">‡¶®‡¶ø‡¶â‡¶ú ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶∞‡¶∞: ${error.message}</p>`;
            if (window.Telegram && window.Telegram.WebApp) {
                tg.showAlert(`‚ùå ‡¶®‡¶ø‡¶â‡¶ú ‡¶≤‡ßã‡¶° ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ${error.message}`);
            }
        });
}

// ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶æ (‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶∏‡¶π)
window.openNewsTask = async function(id, isEarningAttempt=true) {
    try {
        const doc = await db.collection("news").doc(id).get();
        if (!doc.exists) return; 

        currentTask = {...doc.data(), id: doc.id}; 
        
        // ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        if (isEarningAttempt && VideoAdController) {
            VideoAdController.show().then(() => {
                startReadingLogic(id, isEarningAttempt);
            }).catch((e) => {
                console.log("Ad skipped/failed", e);
                startReadingLogic(id, isEarningAttempt); // ‡¶´‡ßá‡¶á‡¶≤ ‡¶ï‡¶∞‡¶≤‡ßá‡¶ì ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶¨‡ßá
            });
        } else {
            startReadingLogic(id, isEarningAttempt);
        }
    } catch (e) {
         tg.showAlert("‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶è‡¶∞‡¶∞: " + e.message);
    }
};

// ‡¶™‡ßú‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞
function startReadingLogic(id, isEarning) {
