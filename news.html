<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News - Headline</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script> 
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <style>
        .news-earn-card { background:white; border-radius:15px; margin-bottom:20px; box-shadow:0 4px 12px rgba(0,0,0,0.05); overflow:hidden; }
        .news-image { width:100%; height:140px; object-fit:cover; }
        .news-content { padding:15px; }
        .news-title { font-size:18px; font-weight:bold; margin-bottom:8px; }
        .news-description { font-size:14px; color:#555; margin-bottom:12px; }
        .task-footer { display:flex; justify-content:space-between; align-items:center; padding-top:12px; border-top:1px solid #eee; }
        .btn-earn { background:#6a5acd; color:white; padding:10px 18px; border-radius:10px; font-weight:bold; }
        .earn-info strong { color:#6a5acd; font-size:15px; }

        /* ‡¶™‡¶™‡¶Ü‡¶™ */
        .popup-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; display:none; justify-content:center; align-items:center; }
        .popup { background:white; padding:30px; border-radius:20px; text-align:center; max-width:90%; border:5px solid #27ae60; }
        .popup i { font-size:60px; color:#27ae60; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="title" style="margin-bottom:20px;">News & Earn</h2>
        <div id="news-task-list"></div>
    </div>

    <!-- Task Modal (In-App Browser + Timer) -->
    <div id="task-modal" style="position:fixed; top:0; left:0; right:0; bottom:0; background:white; z-index:2000; display:none; padding:10px;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px;">
            <button onclick="closeTask()" style="background:none; border:none; font-size:24px; color:#6a5acd;">Close</button>
            <h4 id="timer-display" style="margin:0; color:#6a5acd;">Time: 00:00</h4>
            <button id="complete-btn" disabled style="background:#27ae60; color:white; padding:8px 15px; border-radius:8px;">Complete</button>
        </div>
        <iframe id="news-iframe" style="width:100%; height:calc(100% - 60px); border:none; margin-top:10px;" allow="fullscreen; geolocation; camera; microphone"></iframe>
    </div>

    <!-- Success Popup -->
    <div class="popup-overlay" id="success-popup">
        <div class="popup">
            <i class="fas fa-check-circle"></i><br><br>
            <h3>‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®!</h3>
            <p id="earn-message">‡¶Ü‡¶™‡¶®‡¶ø ‡ßß‡ß¶ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶â‡¶™‡¶æ‡¶∞‡ßç‡¶ú‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®!</p>
        </div>
    </div>

    <nav class="bottom-nav">
  <button class="nav-item" onclick="goToHome()">Home</button>
  <button class="nav-item" onclick="goToSupport()">Support</button>
  <button class="nav-item active">News</button>
  <button class="nav-item"onclick="goToWithdraw()">Withdraw</button>
  <button class="nav-item"onclick="goToProfile()">Profile</button>
  
</nav>

    <script>
// news.html ‡¶è‡¶∞ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü

// ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
const VIDEO_BLOCK_ID = "17912"; 
const INTERSTITIAL_BLOCK_ID = "int-17913";

const firebaseConfig = {
    apiKey: "AIzaSyBQf-ILFW6jDV-c_O2LG6elA5oAB84p2XQ",
    authDomain: "top-news-91db8.firebaseapp.com",
    databaseURL: "https://top-news-91db8-default-rtdb.firebaseio.com",
    projectId: "top-news-91db8",
    storageBucket: "top-news-91db8.firebasestorage.app",
    messagingSenderId: "348369077928",
    appId: "1:348369077928:web:7629c503c30cbf7450649d",
    measurementId: "G-7GMX8N2NSC"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore(); 

// Adsgram Init
let VideoAdController = window.Adsgram?.init({ blockId: VIDEO_BLOCK_ID });
let InterstitialAdController = window.Adsgram?.init({ blockId: INTERSTITIAL_BLOCK_ID });

// üî• ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ: ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶´‡¶ø‡¶ï‡ßç‡¶∏
let currentUser = null; 
const tg = window.Telegram.WebApp;

if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
    tg.ready();
    tg.expand();
    currentUser = tg.initDataUnsafe.user.id.toString();
} else {
    // ‡¶Ø‡¶¶‡¶ø ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú ‡¶¨‡¶æ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü‡ßá‡¶° ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞
    currentUser = localStorage.getItem('newsApp_guestId');
    if (!currentUser) {
        currentUser = "guest_" + Date.now();
        localStorage.setItem('newsApp_guestId', currentUser);
    }
}
// üî• ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶° ‡¶∂‡ßá‡¶∑: ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶´‡¶ø‡¶ï‡ßç‡¶∏

let currentTask = null;
let timerInterval = null;
let timer = 0;

// ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶®
// üî• ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: window.location.href ‡¶ï‡¶≤‡¶ï‡ßá setTimeout-‡¶è ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶≤‡ßã
function goToHome() { setTimeout(() => window.location.href = 'index.html', 0); }
function goToSupport() { setTimeout(() => window.location.href = 'support.html', 0); }
function goToNews() { setTimeout(() => window.location.href = 'news.html', 0); } // ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶¨‡¶æ‡¶®‡¶æ‡¶® ‡¶†‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
function goToWithdraw() { setTimeout(() => window.location.href = 'withdraw.html', 0); }
function goToProfile() { setTimeout(() => window.location.href = 'profile.html', 0); }
// üî• ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶∂‡ßá‡¶∑

// ‡¶®‡¶ø‡¶â‡¶ú ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
function loadNewsFirestore() {
    const container = document.getElementById("news-task-list");
    container.innerHTML = '<p style="text-align:center;">‡¶®‡¶ø‡¶â‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>';

    // ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶∏‡ßá‡¶á ‡¶®‡¶ø‡¶â‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá ‡¶Ø‡¶æ ‡¶è‡¶ñ‡¶®‡ßã ‡¶™‡ßú‡¶æ ‡¶π‡ßü‡¶®‡¶ø
    db.collection("news").orderBy("timestamp", "desc").onSnapshot(async snap => {
        container.innerHTML = "";
        if(snap.empty) {
            container.innerHTML = '<p style="text-align:center;">‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶ø‡¶â‡¶ú ‡¶®‡ßá‡¶á‡•§</p>';
            return;
        }
        
        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶≤‡ßã‡¶°
        let userData = null;
        if (currentUser && !currentUser.startsWith('guest_')) {
            const userDoc = await db.collection('users').doc(currentUser).get();
            userData = userDoc.data();
        }

        snap.forEach(doc => {
            const n = doc.data();
            const readKey = `read_${currentUser}_${doc.id}`; 
            // üî• ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏‡ßá adsWatchedToday ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ
            const alreadyRead = localStorage.getItem(readKey) || (userData && userData.readNews?.[doc.id]);
            const isDailyLimitReached = userData?.adsWatchedToday >= 10;
            
            let buttonText = "Earn Now";
            let onClickFn = `openNewsTask('${doc.id}')`; 
            let isDisabled = false;

            if (alreadyRead) {
                buttonText = "Viewed";
                onClickFn = `openNewsTask('${doc.id}', false)`; // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
                isDisabled = true;
            } else if (isDailyLimitReached) {
                buttonText = "Limit Reached";
                onClickFn = `tg.showAlert('‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∏‡ßÄ‡¶Æ‡¶æ ‡¶∂‡ßá‡¶∑ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');`;
                isDisabled = true;
            } else {
                buttonText = "Earn Now";
            }
            
            container.innerHTML += `
                <div class="news-earn-card" style="${alreadyRead || isDailyLimitReached ? 'opacity: 0.6;' : ''}">
                    <img src="${n.imageUrl}" class="news-image" onerror="this.style.display='none'">
                    <div class="news-content">
                        <h3 class="news-title">${n.title}</h3>
                        <p class="news-description">${n.description}</p>
                        <div class="task-footer">
                            <button class="btn-earn" onclick="${onClickFn}" ${isDisabled ? 'disabled' : ''}> 
                                ${buttonText}
                            </button>
                            ${!alreadyRead && !isDailyLimitReached ? `<div class="earn-info"><strong>‡ß≥${n.points}</strong> ‚Ä¢ ${Math.ceil(n.readTime/60)} min</div>` : ''}
                        </div>
                    </div>
                </div>`;
        });
    });
}

// ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶æ (‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶∏‡¶π)
window.openNewsTask = async function(id, isEarningAttempt=true) {
    const doc = await db.collection("news").doc(id).get();
    if (!doc.exists) return; 

    currentTask = {...doc.data(), id: doc.id}; 
    
    // ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
    if (isEarningAttempt && VideoAdController) {
        VideoAdController.show().then(() => {
            startReadingLogic(id, isEarningAttempt);
        }).catch((e) => {
            console.log("Ad skipped/failed", e);
            startReadingLogic(id, isEarningAttempt); // ‡¶´‡ßá‡¶á‡¶≤ ‡¶ï‡¶∞‡¶≤‡ßá‡¶ì ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶¨‡ßá
        });
    } else {
        startReadingLogic(id, isEarningAttempt);
    }
};

// ‡¶™‡ßú‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞
function startReadingLogic(id, isEarning) {
    const timerDisplay = document.getElementById("timer-display");
    const completeBtn = document.getElementById("complete-btn");
    const modal = document.getElementById("task-modal");
    const iframe = document.getElementById("news-iframe");

    modal.style.display = "block";
    iframe.src = currentTask.link;

    if (isEarning) {
        timer = currentTask.readTime;
        timerDisplay.style.display = "block";
        completeBtn.style.display = "block";
        completeBtn.disabled = true;
        timerDisplay.innerText = `Time: ${formatTime(timer)}`;
        
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timer--;
            timerDisplay.innerText = `Time: ${formatTime(timer)}`;
            if (timer <= 0) {
                clearInterval(timerInterval);
                timerDisplay.innerText = "Completed!";
                completeBtn.disabled = false;
                // ‡¶ï‡¶Æ‡¶™‡ßç‡¶≤‡¶ø‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï
                completeBtn.onclick = () => finishTask(true);
            }
        }, 1000);
    } else {
        // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶™‡ßú‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
        timerDisplay.style.display = "none";
        completeBtn.style.display = "none";
    }
    
    // üî• ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶°: ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü Back ‡¶¨‡¶æ‡¶ü‡¶® ‡¶π‡¶æ‡¶á‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
    tg.BackButton.hide();
}

// ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∂‡ßá‡¶∑ ‡¶ï‡¶∞‡¶æ
async function finishTask(addMoney) {
    const modal = document.getElementById("task-modal");
    const iframe = document.getElementById("news-iframe");
    
    // üî• ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶°: ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∂‡ßá‡¶∑ ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü Back ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
    tg.BackButton.show();
    
    // ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶∏‡ßç‡¶ü‡¶ø‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° (‡¶ï‡ßç‡¶≤‡ßã‡¶ú ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü)
    if (InterstitialAdController) {
        InterstitialAdController.show().catch(e => console.log(e));
    }

    if (addMoney) {
        // ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡¶æ
        try {
             // ‡¶´‡¶æ‡¶Ø‡¶º‡¶æ‡¶∞‡¶¨‡ßá‡¶∏‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶è‡¶¨‡¶Ç adsWatchedToday ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            if (currentUser && !currentUser.startsWith('guest_')) {
                const userRef = db.collection('users').doc(currentUser);
                
                await userRef.update({
                    balance: firebase.firestore.FieldValue.increment(currentTask.points),
                    adsWatchedToday: firebase.firestore.FieldValue.increment(1),
                    // ‡¶®‡¶ø‡¶â‡¶ú‡¶ü‡¶ø ‡¶™‡ßú‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶§‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
                    [`readNews.${currentTask.id}`]: true 
                });
            } else {
                 // Guest user ‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                localStorage.setItem(`read_${currentUser}_${currentTask.id}`, "true");
            }

            // ‡¶∏‡¶æ‡¶ï‡¶∏‡ßá‡¶∏ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú
            document.getElementById("earn-message").innerText = `‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®! ‡ß≥${currentTask.points} ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!`;
            document.getElementById("success-popup").style.display = "flex";
            setTimeout(() => {
                document.getElementById("success-popup").style.display = "none";
                modal.style.display = "none";
                iframe.src = "";
                loadNewsFirestore(); // ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
            }, 2000);
            
        } catch (e) {
            console.error("Firebase update failed:", e);
            tg.showAlert("‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + e.message);
            // ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶≤‡ßá‡¶ì ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶®
            modal.style.display = "none";
            iframe.src = "";
            loadNewsFirestore();
        }

    } else {
        modal.style.display = "none";
        iframe.src = "";
    }
}

// ‡¶ï‡ßç‡¶≤‡ßã‡¶ú ‡¶¨‡¶æ‡¶ü‡¶® (‡¶â‡¶™‡¶∞‡ßá ‡¶¨‡¶æ‡¶Æ‡ßá)
window.closeTask = function() {
    clearInterval(timerInterval);
    document.getElementById("task-modal").style.display = "none";
    document.getElementById("news-iframe").src = "";
    // üî• ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶°: ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü Back ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
    tg.BackButton.show();
}

function formatTime(s) {
    return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
}

// ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
loadNewsFirestore();
</script>


</body>
</html>
