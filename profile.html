<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Headline News</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script> 
    
</head>
<body>
    <div class="container">
        <div class="card profile-header">
            <div class="profile-img-container" style="width: 80px; height: 80px; margin: 0 auto 10px;">
                <img id="profile-photo" src="" alt="Profile">
            </div>
            
            <h3 id="profile-name" class="profile-name">Loading...</h3>
            <p id="profile-username" class="profile-username">@username</p>
        </div>

        <div class="details-section card">
            <div class="title">Account Details</div>
            
            <div class="detail-item">
                <span class="detail-label">User ID</span>
                <span id="user-id" class="detail-value" style="font-size: 12px;">N/A</span>
            </div>

            <div class="detail-item">
                <span class="detail-label">Current Balance</span>
                <span class="detail-value">
                    <span id="current-balance-symbol">à§³</span>
                    <span id="current-balance-value">0.00</span>
                    <span id="current-balance-code" class="currency-code-small">(BDT)</span>
                </span>
            </div>

            <div class="detail-item">
                <span class="detail-label">Total Points</span>
                <span class="detail-value">
                    <span id="total-points-count">0</span> Points 
                    <span style="font-size: 14px; color: #555;">(
                        <span id="total-points-value-symbol">à§³</span>
                        <span id="total-points-value">0.00</span>
                    )</span>
                </span>
            </div>

            <div class="detail-item">
                <span class="detail-label">Total Referrals</span>
                <span id="total-referrals" class="detail-value">0 Users</span>
            </div>

            <div class="detail-item">
                <span class="detail-label">Country</span>
                <span id="user-country" class="detail-value">Bangladesh</span>
            </div>
            
        </div>

        <div class="card">
            <div class="title">Currency Setting</div>
            <div class="input-field">
                <label for="currency-selector-profile">Select Preferred Currency</label>
                <select id="currency-selector-profile">
                    <option value="BDT">BDT - Bangladeshi Taka (à§³)</option>
                    <option value="USD">USD - US Dollar ($)</option>
                    <option value="INR">INR - Indian Rupee (â‚¹)</option>
                    <option value="PKR">PKR - Pakistani Rupee (Rs)</option>
                </select>
            </div>
        </div>
        
        <div class="card">
            <div class="title">Convert Points to Balance</div>
            <p style="font-size: 12px; color: #e74c3c; margin-bottom: 10px;">Minimum 1000 Points required to convert.</p>
            <div class="input-field">
                <label for="points-to-convert">Points to Convert (Max: <span id="max-points">0</span>)</label>
                <input type="number" id="points-to-convert" min="1000" placeholder="Enter points (e.g., 1000)">
            </div>
            <p id="conversion-result" style="font-size: 14px; color: #6c5ce7; margin: 10px 0; text-align: center;">Conversion result will appear here.</p>
            <button id="convert-btn" class="btn btn-primary" disabled>Convert Points</button>
        </div>

        <div class="card">
            <div class="title">Other Options</div>
            <button class="btn btn-secondary" onclick="openSupport()">Support & Contact</button>
            <button class="btn btn-danger" onclick="logout()">Logout</button>
        </div>

    </div>

   <nav class="bottom-nav">
  <button class="nav-item" onclick="goToHome()">Home</button>
  <button class="nav-item" onclick="goToSupport()">Support</button>
  <button class="nav-item " onclick="goToNews()">News</button>
  <button class="nav-item"onclick="goToWithdraw()">Withdraw</button>
  <button class="nav-item active">Profile</button>
  
</nav>
    <div class="popup-overlay" id="logout-popup" style="display: none;">
        <div class="popup" style="border: 4px solid #e74c3c;">
            <i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i><br>
            <p style="font-weight: bold; margin-bottom: 15px;">Are you sure you want to log out?</p>
            <button class="btn btn-danger" onclick="confirmLogout()">Yes, Logout</button>
            <button class="btn btn-secondary" onclick="document.getElementById('logout-popup').style.display='none'">Cancel</button>
        </div>
    </div>

    <script>
    
    
    const firebaseConfig = {
    apiKey: "AIzaSyBQf-ILFW6jDV-c_O2LG6elA5oAB84p2XQ",
    authDomain: "top-news-91db8.firebaseapp.com",
    databaseURL: "https://top-news-91db8-default-rtdb.firebaseio.com",
    projectId: "top-news-91db8",
    storageBucket: "top-news-91db8.firebasestorage.app",
    messagingSenderId: "348369077928",
    appId: "1:348369077928:web:7629c503c30cbf7450649d",
    measurementId: "G-7GMX8N2NSC"
  };

firebase.initializeApp(firebaseConfig);
// âœ… Firebase.database() à¦à¦° à¦¬à¦¦à¦²à§‡ Firestore à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à¦¾ à¦¹à¦²à§‹
const db = firebase.firestore();

let userId = null;

const CURRENCY_RATES = {
    'BDT': { symbol: 'à§³', rate: 110.00 },
    'USD': { symbol: '$', rate: 1 },
    'INR': { symbol: 'â‚¹', rate: 83.50 },
    'PKR': { symbol: 'Rs', rate: 279.00 }
};
const POINT_VALUE_USD = 0.01; 
const MIN_CONVERT_POINTS = 1000;

// ... (Helper functions remain the same) ...

async function getLiveExchangeRates() {
    return CURRENCY_RATES;
}

async function convertUSDToCurrency(usdValue, currencyCode) {
    const rates = await getLiveExchangeRates();
    const rateData = rates[currencyCode] || rates['BDT'];
    const convertedValue = usdValue * rateData.rate;
    return {
        value: convertedValue.toFixed(2),
        symbol: rateData.symbol,
        code: currencyCode
    };
}

function convertPointsToUSD(points) {
    return (points / 1000) * POINT_VALUE_USD;
}


function loadProfileData() {
    if (!window.Telegram?.WebApp) return alert("à¦Ÿà§‡à¦²à¦¿à¦—à§à¦°à¦¾à¦® à¦¥à§‡à¦•à§‡ à¦–à§à¦²à§à¦¨!");

    Telegram.WebApp.ready();
    const tg = Telegram.WebApp.initDataUnsafe;
    const user = tg.user || { id: Date.now(), first_name: "Guest" };

    userId = user.id.toString();

    document.getElementById("profile-name").innerText = user.first_name + (user.last_name ? " " + user.last_name : "");
    document.getElementById("profile-username").innerText = user.username ? "@" + user.username : "@user" + user.id;
    document.getElementById("user-id").innerText = user.id;
    if (user.photo_url) {
        document.getElementById("profile-photo").src = user.photo_url;
    }
    
    // ðŸ’¡ à¦«à¦¿à¦•à§à¦¸: à¦•à¦¾à¦°à§‡à¦¨à§à¦¸à¦¿ à¦¸à§‡à¦Ÿà¦¿à¦‚ à¦…à¦¨à¦šà§‡à¦žà§à¦œ à¦²à¦œà¦¿à¦•
    const selector = document.getElementById("currency-selector-profile");
    if (selector) {
        selector.onchange = function() {
            // âœ… Firestore: .update() à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§‡ à¦•à¦¾à¦°à§‡à¦¨à§à¦¸à¦¿ à¦¸à§‡à¦­
            db.collection("users").doc(userId).update({ currency: this.value });
        };
    }

    // âœ… Firestore à¦²à¦¿à¦¸à§‡à¦¨à¦¾à¦°: .onSnapshot à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§‡ à¦°à¦¿à¦¯à¦¼à§‡à¦²-à¦Ÿà¦¾à¦‡à¦® à¦†à¦ªà¦¡à§‡à¦Ÿ
    db.collection("users").doc(userId).onSnapshot(doc => {
        const data = doc.data() || {};
        
        const userCurrency = data.currency || 'BDT';
        const userPoints = data.points || 0;
        
        if (selector) {
            selector.value = userCurrency; 
        }

        // UI à¦†à¦ªà¦¡à§‡à¦Ÿ à¦²à¦œà¦¿à¦•
        const convertedBalance = convertUSDToCurrency(data.balance || 0, userCurrency);
        const pointsUSDValue = convertPointsToUSD(userPoints);
        const convertedPointsValue = convertUSDToCurrency(pointsUSDValue, userCurrency);
        
        // Asynchronous conversion calls:
        Promise.all([convertedBalance, convertedPointsValue]).then(([bal, pts]) => {
            // âœ… à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸ à¦¡à¦¿à¦¸à¦ªà§à¦²à§‡ à¦†à¦ªà¦¡à§‡à¦Ÿ
            document.getElementById("current-balance-symbol").innerText = bal.symbol;
            document.getElementById("current-balance-value").innerText = bal.value;
            document.getElementById("current-balance-code").innerText = `(${bal.code})`;

            document.getElementById("total-referrals").innerText = (data.referrals || 0) + " Users";
            document.getElementById("user-country").innerText = data.country || "Bangladesh";
            
            // âœ… à¦ªà¦¯à¦¼à§‡à¦¨à§à¦Ÿ à¦­à§à¦¯à¦¾à¦²à§ à¦¡à¦¿à¦¸à¦ªà§à¦²à§‡ à¦†à¦ªà¦¡à§‡à¦Ÿ
            document.getElementById("total-points-count").innerText = userPoints.toLocaleString();
            document.getElementById("total-points-value-symbol").innerText = pts.symbol;
            document.getElementById("total-points-value").innerText = pts.value;

            // à¦•à¦¨à¦­à¦¾à¦°à§à¦Ÿ à¦¬à¦¾à¦Ÿà¦¨à§‡à¦° à¦²à¦œà¦¿à¦•
            const maxPointsDisplay = document.getElementById("max-points");
            const pointsInput = document.getElementById("points-to-convert");

            if (maxPointsDisplay) maxPointsDisplay.innerText = userPoints.toLocaleString();
            if (pointsInput) pointsInput.max = userPoints;
            
            pointsInput?.oninput();
        });
    });
    
    // ðŸ’¡ à¦ªà¦¯à¦¼à§‡à¦¨à§à¦Ÿ à¦•à¦¨à¦­à¦¾à¦°à§à¦Ÿ à¦‡à¦¨à¦ªà§à¦Ÿ à¦¹à§à¦¯à¦¾à¦¨à§à¦¡à¦²à¦¾à¦° 
    const pointsInput = document.getElementById("points-to-convert");
    const resultDisplay = document.getElementById("conversion-result");
    if (pointsInput && resultDisplay) {
        pointsInput.oninput = async function() {
            // ... (conversion calculation logic remains the same) ...
            let points = parseInt(this.value) || 0;
            const userCurrency = document.getElementById("currency-selector-profile").value; 
            
            if (points > parseInt(this.max)) {
                points = parseInt(this.max);
                this.value = points;
            }
            
            const usdValue = convertPointsToUSD(points);
            const converted = await convertUSDToCurrency(usdValue, userCurrency); 
            
            resultDisplay.innerText = `You will get ${converted.symbol}${converted.value} (${converted.code}) for $${usdValue.toFixed(4)} USD`;
            document.getElementById("convert-btn").disabled = (points < MIN_CONVERT_POINTS);
        };
    }

    // à¦•à¦¨à¦­à¦¾à¦°à§à¦Ÿ à¦¬à¦¾à¦Ÿà¦¨ à¦•à§à¦²à¦¿à¦• à¦¹à§à¦¯à¦¾à¦¨à§à¦¡à¦²à¦¾à¦°
    const convertBtn = document.getElementById("convert-btn");
    if (convertBtn) {
        convertBtn.onclick = handlePointConversion;
    }
}

function handlePointConversion() {
    const pointsInput = document.getElementById("points-to-convert");
    let pointsToConvert = parseInt(pointsInput.value) || 0;
    
    if (pointsToConvert < MIN_CONVERT_POINTS) {
        alert(`Minimum conversion is ${MIN_CONVERT_POINTS} Points.`);
        return;
    }
    
    // âœ… Firestore Transaction: à¦ªà¦¯à¦¼à§‡à¦¨à§à¦Ÿ à¦•à¦¾à¦Ÿà¦¾à¦¨à§‹ à¦à¦¬à¦‚ à¦¬à§à¦¯à¦¾à¦²à§‡à¦¨à§à¦¸ à¦¯à§‹à¦— à¦•à¦°à¦¾
    const userRef = db.collection("users").doc(userId);
    const usdGain = convertPointsToUSD(pointsToConvert);
    
    db.runTransaction(transaction => {
        return transaction.get(userRef).then(doc => {
            if (!doc.exists) {
                throw "Document does not exist!";
            }
            
            const data = doc.data();
            const currentPoints = data.points || 0;
            const currentBalance = data.balance || 0;
            
            if (pointsToConvert > currentPoints) {
                alert("Insufficient Points.");
                return;
            }
            
            const newPoints = currentPoints - pointsToConvert;
            const newBalance = currentBalance + usdGain;
            
            transaction.update(userRef, { points: newPoints, balance: newBalance });
        });
    }).then(() => {
        alert(`${pointsToConvert} Points successfully converted to $${usdGain.toFixed(4)} USD!`);
        pointsInput.value = ''; 
    }).catch(error => {
        console.error("Transaction failed: ", error);
        alert("Conversion Failed: " + error);
    });
}

function openSupport() {
    Telegram.WebApp.openTelegramLink("https://t.me/Headline_newsbot"); 
}

function logout() {
    document.getElementById("logout-popup").style.display = "flex";
}

function confirmLogout() {
    localStorage.clear();
    Telegram.WebApp.close();
}

document.addEventListener('DOMContentLoaded', () => {
    if (window.Telegram && window.Telegram.WebApp) {
        Telegram.WebApp.ready(loadProfileData);
    } else {
        loadProfileData();
    }
});

function goToHome() { window.location.href = 'index.html'; }
function goToSupport() { window.location.href = 'support.html'; }
function goToNews() { window.location.href = 'news.html'; }
function goToWithdraw() { window.location.href = 'withdraw.html'; }
function goToProfile() { window.location.href = 'profile.html'; }

    
    </script>
</body>
</html>
